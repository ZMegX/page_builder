{% extends "base.html" %}
{% load static %}


{% block title %}Manage Delivery Addresses{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h4 class="mb-0 py-2 fs-4 text-primary-emphasis">
                <i class="bi bi-geo-alt-fill me-2"></i> Add a New Delivery Address
            </h4>
        </div>
        <div class="card-body">
            <p class="card-text">Start typing an address in the box below. Select a valid location from the dropdown to save it.</p>
            <div id="address-form" class="d-flex gap-3">
                <input id="autocomplete" class="form-control form-control-lg" placeholder="Start typing your delivery address..." type="text" />
                <button id="save-address" class="btn btn-primary btn-lg" style="white-space: nowrap;">Save Address</button>
            </div>
            <div id="feedback-message" class="mt-2" style="min-height: 24px;"></div>
        </div>
    </div>

    <hr class="my-4">

    <h4 class="mb-3 fs-4 text-primary-emphasis">
        <i class="bi bi-pin-map-fill me-2"></i> Your Saved Locations
    </h4>
    <div id="map"
        data-api-key="{{ GOOGLE_MAPS_API_KEY }}"
        data-api-url="{% url 'locations:address-list-create' %}">
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
  // Log a message to the console as soon as this script block starts
  console.log("extra_js block started. The map div should exist now.");

  // Let's try to find the map div right away
  const mapDiv = document.getElementById("map");

  // Check if we found it
  if (mapDiv) {
    console.log("SUCCESS: Found the <div id='map'> element.", mapDiv);
  } else {
    console.error("FAILURE: Could NOT find the <div id='map'> element. It is null.");
  }

  // Only proceed if mapDiv was actually found
  if (mapDiv) {
    (async function() {
      console.log("Starting async function to load Google Maps.");
      
      const apiKey = mapDiv.dataset.apiKey;
      if (!apiKey) {
          console.error("ERROR: API key is missing from data-api-key attribute!");
          return; // Stop if no key
      }

      // Bootstrap loader code
      (g => {
        var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
        b = b[c] || (b[c] = {});
        var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
          u = () => h || (h = new Promise(async (f, n) => {
            await (a = m.createElement("script"));
            e.set("libraries", [...r] + "");
            for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
            e.set("callback", c + ".maps." + q);
            a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
            d[q] = f;
            a.onerror = () => h = n(Error(p + " could not load."));
            a.nonce = m.querySelector("script[nonce]")?.nonce || "";
            m.head.append(a)
          }));
        d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
      })({
        key: apiKey,
        v: "weekly",
      });

      async function initMap() {
        console.log("initMap: Loading libraries...");
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        const { Place } = await google.maps.importLibrary("places");
        console.log("initMap: Libraries loaded.");

        const position = { lat: -34.397, lng: 150.644 };

        const map = new google.maps.Map(document.getElementById("map"), {
          center: position,
          zoom: 8,
          mapId: "DEMO_MAP_ID",
        });
        console.log("initMap: Map initialized.");

        const marker = new AdvancedMarkerElement({ map: map, position: position });
        console.log("initMap: Marker created.");
        
        const autocompleteInput = document.getElementById("autocomplete");
        const autocomplete = new Autocomplete(autocompleteInput, { fields: ["address_components", "geometry", "icon", "name"] });
        console.log("initMap: Autocomplete initialized.");
      }

      initMap();

    })();
  }
</script>
{% endblock %}