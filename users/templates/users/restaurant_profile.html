{% extends "base.html" %}
{% block title %}Restaurant Profile - Page Builder{% endblock %}
{% load crispy_forms_tags %}
{% load static %}
<link rel="stylesheet" href="{% static 'users/restaurant_profile.css' %}">
{% block extra_css %}
<style>
  #place-picker { width: 100%; }
  .btn-save-custom {
    color: #222 !important;
    border: 1.5px solid #222 !important;
    background: #fff !important;
    border-radius: 0.6rem !important;
    font-size: 1.12rem !important;
    font-weight: 600;
    width: 100%;
    transition: color .2s, background .2s;
  }
  .btn-save-custom:hover, .btn-save-custom:focus {
    color: #fff !important;
    background: #222 !important;
    border: 1.5px solid #222 !important;
  }
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Top Save Button -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body">
  <button type="submit" form="restaurant-profile-form" class="btn btn-save-custom mt-3">
        <i class="bi bi-save me-2"></i> Save All Profile Changes
      </button>
    </div>
  </div>
  <form id="restaurant-profile-form" method="POST" enctype="multipart/form-data" autocomplete="off">
    {% csrf_token %}
    <div class="row g-4">
      <!-- Restaurant Details -->
      <div class="col-lg-7">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-info-circle me-2"></i> Restaurant Details</h5>
          </div>
          <div class="card-body">
            {% if rp_form.errors %}
              <div class="alert alert-danger">
                {{ rp_form.non_field_errors }}
                {% for field in rp_form %}
                  {% for error in field.errors %}
                    <div>{{ field.label }}: {{ error }}</div>
                  {% endfor %}
                {% endfor %}
              </div>
            {% endif %}
            {% for field in rp_form %}
              {% if field.name != "logo" %}
                {{ field|as_crispy_field }}
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Social Links -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-share me-2"></i> Social Links</h5>
          </div>
          <div class="card-body">
            {{ social_fs.management_form }}
            {% if social_fs.non_form_errors %}
              <div class="alert alert-danger">
                {{ social_fs.non_form_errors }}
              </div>
            {% endif %}
            {% for form in social_fs %}
              {{ form.id }}
              {% if form.errors %}
                <div class="alert alert-danger">
                  {% for field in form %}
                    {% for error in field.errors %}
                      <div>{{ field.label }}: {{ error }}</div>
                    {% endfor %}
                  {% endfor %}
                </div>
              {% endif %}
              <div class="row g-3 mb-2 align-items-center">
                <div class="col-md-5">{{ form.name|as_crispy_field }}</div>
                <div class="col-md-7">{{ form.url|as_crispy_field }}</div>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Opening Hours -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-clock me-2"></i> Opening Hours</h5>
          </div>
          <div class="card-body">
            {{ hours_fs.management_form }}
            {% if hours_fs.non_form_errors %}
              <div class="alert alert-danger">
                {{ hours_fs.non_form_errors }}
              </div>
            {% endif %}
            {% for form in hours_fs %}
              {{ form.id }}
              {% if form.errors %}
                <div class="alert alert-danger">
                  {% for field in form %}
                    {% for error in field.errors %}
                      <div>{{ field.label }}: {{ error }}</div>
                    {% endfor %}
                  {% endfor %}
                </div>
              {% endif %}
              <div class="row g-3 mb-2 align-items-center">
                <div class="col-md-4">{{ form.day_of_week|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.open_time|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.close_time|as_crispy_field }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Right Column: Logo and Addresses -->
      <div class="col-lg-5">
        <!-- Logo -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-image me-2"></i> Logo</h5>
          </div>
          <div class="card-body text-center">
            <img id="logoPreview" src="{{ rp_form.instance.logo.url|default:'https://via.placeholder.com/300x200.png?text=No+Logo' }}" class="img-fluid rounded mb-3" style="max-height: 250px; object-fit: cover;" alt="Logo preview">
            {{ rp_form.logo|as_crispy_field }}
          </div>
        </div>
        <!-- Address Management -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-geo-alt me-2"></i> Delivery Addresses</h5>
          </div>
          <div class="card-body">
            <script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"></script>
            <gmpx-api-loader key="{{ GOOGLE_MAPS_API_KEY }}"></gmpx-api-loader>
            <gmpx-place-picker id="place-picker" placeholder="Enter an address to add"></gmpx-place-picker>
            <div id="feedback-message" class="mt-2 small" style="min-height: 20px;"></div>
            <hr>
            <h6 class="text-muted mb-2">Saved Locations</h6>
            <ul id="address-list" class="list-group list-group-flush">
              {% if saved_addresses %}
                {% for address in saved_addresses %}
                  <li id="address-{{ address.id }}" class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="flex-grow-1">{{ address.formatted_address }}</span>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-address-btn ms-2" data-address-id="{{ address.id }}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </li>
                {% endfor %}
              {% else %}
                <li id="no-addresses-alert" class="list-group-item text-muted">No addresses saved yet.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
      <!-- Save Button -->
      <div class="col-12">
        <div class="card shadow-sm border-0 rounded-4 mt-4">
          <div class="card-body text-end">
            <button type="submit" class="btn btn-primary btn-lg px-4">
              <i class="bi bi-save me-2"></i> Save All Profile Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // logo preview
  const logoInput = document.querySelector('[name="logo"]');
  if (logoInput) {
    logoInput.addEventListener('change', function(event) {
      const preview = document.getElementById('logoPreview');
      const file = event.target.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
      }
    });
  }

  // --- Address Management ---
  const placePicker = document.getElementById('place-picker');
  const feedbackMessage = document.getElementById('feedback-message');
  const addressList = document.getElementById('address-list');

  placePicker.addEventListener('gmpx-placechange', () => {
    const selectedPlace = placePicker.value;
    if (selectedPlace?.location) {
      saveAddress(selectedPlace);
    }
  });

  async function saveAddress(place) {
    feedbackMessage.innerHTML = '<span class="text-primary">Saving address...</span>';
    const data = {
      formatted_address: place.formattedAddress,
      latitude: place.location.lat(),
      longitude: place.location.lng()
    };

    try {
      const response = await fetch("{% url 'locations:address-list-create' %}", {
        method: "POST",
        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const newAddress = await response.json();
        addAddressToList(newAddress);
        feedbackMessage.innerHTML = '<span class="text-success">Address added!</span>';
        placePicker.value = null;
      } else {
        const errorText = await response.text();
        feedbackMessage.innerHTML = `<span class="text-danger">Error: ${errorText}</span>`;
      }
    } catch (error) {
      feedbackMessage.innerHTML = '<span class="text-danger">A network error occurred.</span>';
      console.error("Save address error:", error);
    }
  }

  function addAddressToList(address) {
    document.getElementById('no-addresses-alert')?.remove();

    const li = document.createElement('li');
    li.id = `address-${address.id}`;
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <span class="flex-grow-1">${address.formatted_address}</span>
      <button type="button" class="btn btn-outline-danger btn-sm delete-address-btn ms-2" data-address-id="${address.id}">
        <i class="bi bi-trash"></i>
      </button>
    `;
    addressList.appendChild(li);

    new bootstrap.Tooltip(li.querySelector('.delete-address-btn'));
  }

  addressList.addEventListener('click', async function(event) {
    const deleteButton = event.target.closest('.delete-address-btn');
    if (!deleteButton) return;

    const addressId = deleteButton.dataset.addressId;
    const url = `/locations/api/addresses/${addressId}/delete/`;

    if (!confirm('Are you sure you want to delete this address?')) return;

    try {
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {'X-CSRFToken': csrftoken}
      });

      if (response.ok) {
        document.getElementById(`address-${addressId}`).remove();
        if (addressList.children.length === 0) {
            addressList.innerHTML = '<li id="no-addresses-alert" class="list-group-item text-muted">No addresses saved yet.</li>';
        }
      } else {
        const errorData = await response.json();
        alert(`Failed to delete address: ${errorData.message || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Delete address error:', error);
      alert('A network error occurred while trying to delete the address.');
    }
  });

  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
});
</script>
{% endblock %}