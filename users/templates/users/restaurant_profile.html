{% extends "base.html" %}
{% block title %}Restaurant Profile - Page Builder{% endblock %}
{% load static crispy_forms_tags %}

{% block content %}
<div class="container py-4">
  {# The form now only needs to wrap the sections it controls #}
  <div class="row g-4">
    <!-- Left Column for Details and Address -->
    <div class="col-lg-8">
      <!-- Restaurant Details (card) -->
      <div class="card shadow-sm border-0 rounded-4 mb-4">
        <form method="POST" enctype="multipart/form-data" autocomplete="off">
          {% csrf_token %}
          <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex align-items-center">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis">
              <i class="bi bi-info-circle me-2"></i> Restaurant Details
            </h5>
            <button type="submit" class="btn btn-outline-success btn-sm ms-auto" name="save_rp">
              <i class="bi bi-save me-1"></i> Save Details
            </button>
          </div>
          <div class="card-body">
            <div class="row g-4">
              {# Render all profile fields except the logo #}
              {% for field in rp_form %}
                {% if field.name != "logo" %}
                  <div class="col-12">
                    {{ field|as_crispy_field }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </form>
      </div>

      <!-- Address Display (Full Width Below Details) -->
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex align-items-center">
          <h5 class="mb-0 py-2 fs-5 text-primary-emphasis">
            <i class="bi bi-geo-alt me-2"></i> Delivery Addresses
          </h5>
          <a href="{% url 'locations:map_view' %}" class="btn btn-outline-primary btn-sm ms-auto">
            <i class="bi bi-pencil-square me-1"></i> Add or Manage Addresses
          </a>
        </div>
        <div class="card-body">
          {% if saved_addresses %}
            <ul class="list-group list-group-flush">
              {% for address in saved_addresses %}
                <li class="list-group-item">{{ address.formatted_address }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="alert alert-light" role="alert">
              You have not saved any delivery addresses yet. Use the button above to add one.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column for Logo -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 rounded-4 h-100">
        <form method="POST" enctype="multipart/form-data" autocomplete="off">
          {% csrf_token %}
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis">
              <i class="bi bi-image me-2"></i> Logo
            </h5>
          </div>
          <div class="card-body">
            <div class="ratio ratio-16x9 bg-light border rounded position-relative overflow-hidden mb-3">
              {% if rp_form.instance.logo %}
                <img id="logoPreview" src="{{ rp_form.instance.logo.url }}" class="w-100 h-100" style="object-fit: cover;" alt="Logo preview">
              {% else %}
                <img id="logoPreview" class="w-100 h-100 d-none" style="object-fit: cover;" alt="Logo preview">
                <div id="logoPlaceholder" class="position-absolute top-50 start-50 translate-middle text-muted text-center">
                  <i class="bi bi-image" style="font-size: 2rem;"></i>
                  <div class="small">No image</div>
                </div>
              {% endif %}
            </div>
            {{ rp_form.logo|as_crispy_field }}
            <div class="form-text">PNG or JPG. Square images work best.</div>
            {# You could add a separate save button for the logo if needed, or rely on the main details save #}
          </div>
        </form>
      </div>
    </div>

    <!-- Social Links (full width) -->
    <div class="col-12">
      <div class="card shadow-sm border-0 rounded-4">
        <form method="POST" autocomplete="off">
          {% csrf_token %}
          <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex align-items-center">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis">
              <i class="bi bi-share me-2"></i> Social Links
            </h5>
            <button type="submit" class="btn btn-outline-success btn-sm ms-auto" name="save_social">
              <i class="bi bi-save me-1"></i> Save Social Links
            </button>
          </div>
          <div class="card-body">
            {{ social_fs.management_form }}
            {% for form in social_fs %}
              <div class="row g-3 mb-2 align-items-center">
                <div class="col-md-5">{{ form.name|as_crispy_field }}</div>
                <div class="col-md-7">{{ form.url|as_crispy_field }}</div>
              </div>
            {% endfor %}
          </div>
        </form>
      </div>
    </div>

    <!-- Opening Hours (full width) -->
    <div class="col-12">
      <div class="card shadow-sm border-0 rounded-4">
        <form method="POST" autocomplete="off">
          {% csrf_token %}
          <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex align-items-center">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis">
              <i class="bi bi-clock me-2"></i> Opening Hours
            </h5>
            <button type="submit" class="btn btn-outline-success btn-sm ms-auto" name="save_hours">
              <i class="bi bi-save me-1"></i> Save Hours
            </button>
          </div>
          <div class="card-body">
            {{ hours_fs.management_form }}
            {% for form in hours_fs %}
              <div class="row g-3 mb-2 align-items-center">
                <div class="col-md-4">{{ form.day_of_week|as_crispy_field }}</div> {# <-- FIX IS HERE #}
                <div class="col-md-4">{{ form.open_time|as_crispy_field }}</div>
                <div class="col-md-4">{{ form.close_time|as_crispy_field }}</div>
              </div>
            {% endfor %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Simple script to preview the logo when a new file is selected.
document.addEventListener('DOMContentLoaded', function() {
  const logoInput = document.querySelector('[name="logo"]');
  if (logoInput) {
    logoInput.addEventListener('change', function(event) {
      const preview = document.getElementById('logoPreview');
      const placeholder = document.getElementById('logoPlaceholder');
      const file = event.target.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.classList.remove('d-none');
        if (placeholder) {
          placeholder.classList.add('d-none');
        }
      }
    });
  }
});
</script>
{% endblock %}