{% extends "base.html" %}
{% block title %}Restaurant Profile - Page Builder{% endblock %}
{% load crispy_forms_tags %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/restaurant_profile.css' %}">
{% endblock %}
{% block content %}
<div class="container py-4">
  <!-- Live Preview Card -->
  <div class="mb-4">
    <div class="card shadow-sm border-0 rounded-4 w-100">
      <div class="card-body d-flex flex-column flex-md-row align-items-center">
        <div class="me-md-4 mb-3 mb-md-0 text-center logo-preview-container">
          <img id="previewLogo" src="{{ rp_form.instance.logo.url|default:'https://via.placeholder.com/180x120.png?text=No+Logo' }}" class="img-fluid rounded preview-logo" alt="Logo preview">
        </div>
        <div class="flex-grow-1">
          <h3 class="fw-bold mb-1">{{ rp_form.instance.name|default:'Restaurant Name' }}</h3>
          <div class="mb-2">
            <span class="badge bg-secondary">{{ rp_form.instance.theme_choice|default:'Default Theme' }}</span>
          </div>
          <div class="mb-2">
            <i class="bi bi-geo-alt me-1"></i>
            {% if saved_addresses and saved_addresses.0.formatted_address %}
              {{ saved_addresses.0.formatted_address }}
            {% else %}
              <span class="text-muted">No address set</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Profile Completeness Progress Bar & Checklist -->
  <div class="mb-4">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body">
        {% with logo_ok=rp_form.instance.logo.url|default_if_none:'' address_ok=saved_addresses.0.formatted_address|default_if_none:'' hours_ok=hours_fs.0.open_time.value|default_if_none:'' %}
        {% with completeness=0 %}
          {% if logo_ok %}{% with completeness=completeness|add:33 %}{% endwith %}{% endif %}
          {% if address_ok %}{% with completeness=completeness|add:33 %}{% endwith %}{% endif %}
          {% if hours_ok %}{% with completeness=completeness|add:34 %}{% endwith %}{% endif %}
          <div class="d-flex align-items-center mb-2">
            <span class="fw-bold me-2">Profile Completeness</span>
            <div class="progress flex-grow-1 profile-progress">
              <div class="progress-bar bg-success" role="progressbar" style="width: {{ completeness }}%;" aria-valuenow="{{ completeness }}" aria-valuemin="0" aria-valuemax="100">{{ completeness }}%</div>
            </div>
          </div>
          <ul class="list-inline mb-0">
            <li class="list-inline-item">
              <i class="bi bi-image profile-icon"></i>
              <span {% if logo_ok %}class="text-success"{% else %}class="text-muted"{% endif %}>Logo {% if logo_ok %}<i class="bi bi-check-circle-fill text-success"></i>{% endif %}</span>
            </li>
            <li class="list-inline-item">
              <i class="bi bi-geo-alt profile-icon"></i>
              <span {% if address_ok %}class="text-success"{% else %}class="text-muted"{% endif %}>Address {% if address_ok %}<i class="bi bi-check-circle-fill text-success"></i>{% endif %}</span>
            </li>
            <li class="list-inline-item">
              <i class="bi bi-clock profile-icon"></i>
              <span {% if hours_ok %}class="text-success"{% else %}class="text-muted"{% endif %}>Opening Hours {% if hours_ok %}<i class="bi bi-check-circle-fill text-success"></i>{% endif %}</span>
            </li>
          </ul>
        {% endwith %}
        {% endwith %}
      </div>
    </div>
  </div>
  <form id="restaurant-profile-form" method="POST" enctype="multipart/form-data" autocomplete="off">
    {% csrf_token %}
    <ul class="nav nav-tabs mb-4" id="profileTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
          <i class="bi bi-info-circle me-1"></i> Details
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="social-tab" data-bs-toggle="tab" data-bs-target="#social" type="button" role="tab" aria-controls="social" aria-selected="false">
          <i class="bi bi-share me-1"></i> Social Links
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hours-tab" data-bs-toggle="tab" data-bs-target="#hours" type="button" role="tab" aria-controls="hours" aria-selected="false">
          <i class="bi bi-clock me-1"></i> Opening Hours
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="logo-tab" data-bs-toggle="tab" data-bs-target="#logo" type="button" role="tab" aria-controls="logo" aria-selected="false">
          <i class="bi bi-image me-1"></i> Logo
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab" aria-controls="location" aria-selected="false">
          <i class="bi bi-geo-alt me-1"></i> Location
        </button>
      </li>
    </ul>
    <div class="tab-content" id="profileTabContent">
      <!-- Staging tab content removed -->
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-info-circle me-2"></i> Restaurant Details</h5>
          </div>
          <div class="card-body">
            {% if rp_form.errors %}
              <div class="alert alert-danger">
                {{ rp_form.non_field_errors }}
                {% for field in rp_form %}
                  {% for error in field.errors %}
                    <div>{{ field.label }}: {{ error }}</div>
                  {% endfor %}
                {% endfor %}
              </div>
            {% endif %}
            <!-- Theme Choice Card -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-palette me-2"></i> Theme</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  {% for value, label in rp_form.theme_choice.field.choices %}
                  <div class="col-auto">
                    <label class="theme-option d-flex flex-column align-items-center p-2 border rounded {% if rp_form.theme_choice.value == value %}border-primary{% endif %}">
                      <input type="radio" name="theme_choice" value="{{ value }}" {% if rp_form.theme_choice.value == value %}checked{% endif %} class="mb-2">
                      <img src="{% static 'themes/previews/' %}{{ value }}-preview.png" alt="{{ label }} preview" class="theme-preview-img">
                      <span>{{ label }}</span>
                    </label>
                  </div>
                  {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">Choose a color theme for your restaurant page.</small>
              </div>
            </div>
            <!-- Hero Section Card -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-image me-2"></i> Hero Section</h6>
              </div>
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-7">
                    {{ rp_form.hero_headline|as_crispy_field }}
                    {{ rp_form.hero_description|as_crispy_field }}
                  </div>
                  <div class="col-md-5 text-center">
                    {% if rp_form.hero_image.value %}
                      <img src="{{ rp_form.hero_image.value.url }}" class="img-fluid rounded" alt="Hero preview" style="max-height:180px;object-fit:cover;">
                    {% else %}
                      <div class="text-muted">No hero image selected</div>
                    {% endif %}
                    <div class="mt-3">
                      {{ rp_form.hero_image|as_crispy_field }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- About Section Card -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i> About Section</h6>
              </div>
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-7">
                    {{ rp_form.about_headline|as_crispy_field }}
                    {{ rp_form.about_description|as_crispy_field }}
                    {{ rp_form.about_highlight|as_crispy_field }}
                  </div>
                  <div class="col-md-5 text-center">
                    {% if rp_form.about_image.value %}
                      <img src="{{ rp_form.about_image.value.url }}" class="img-fluid rounded" alt="About preview" style="max-height:180px;object-fit:cover;">
                    {% else %}
                      <div class="text-muted">No about image selected</div>
                    {% endif %}
                    <div class="mt-3">
                      {{ rp_form.about_image|as_crispy_field }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="social" role="tabpanel" aria-labelledby="social-tab">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-share me-2"></i> Social Links</h5>
          </div>
          <div class="card-body">
            {{ social_fs.management_form }}
            {% if social_fs.non_form_errors %}
              <div class="alert alert-danger">
                {{ social_fs.non_form_errors }}
              </div>
            {% endif %}
            {% for form in social_fs %}
              {{ form.id }}
              {% if form.errors %}
                <div class="alert alert-danger">
                  {% for field in form %}
                    {% for error in field.errors %}
                      <div>{{ field.label }}: {{ error }}</div>
                    {% endfor %}
                  {% endfor %}
                </div>
              {% endif %}
              <div class="row g-3 mb-2 align-items-center">
                <div class="col-md-5">
                  {{ form.name|as_crispy_field }}
                  {% if form.name.errors %}
                    <div class="text-danger small mt-1">
                      {% for error in form.name.errors %}
                        <span class="badge bg-danger">{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% elif form.name.value and not form.name.errors %}
                    <div class="text-success small mt-1">
                      <span class="badge bg-success">Looks good!</span>
                    </div>
                  {% endif %}
                </div>
                <div class="col-md-7 d-flex align-items-center gap-2">
                  <span class="social-icon" data-url="{{ form.url.value|default:'' }}"></span>
                  {{ form.url|as_crispy_field }}
                  {% if form.url.errors %}
                    <div class="text-danger small mt-1">
                      {% for error in form.url.errors %}
                        <span class="badge bg-danger">{{ error }}</span>
                      {% endfor %}
                    </div>
                  {% elif form.url.value and not form.url.errors %}
                    <div class="text-success small mt-1">
                      <span class="badge bg-success">Looks good!</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="hours" role="tabpanel" aria-labelledby="hours-tab">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-clock me-2"></i> Opening Hours</h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="copy-hours-btn">
              <i class="bi bi-clipboard me-1"></i> Copy to All Days
            </button>
          </div>
          <div class="card-body">
            {{ hours_fs.management_form }}
            {% if hours_fs.non_form_errors %}
              <div class="alert alert-danger">
                {{ hours_fs.non_form_errors }}
              </div>
            {% endif %}
            <div class="table-responsive">
              <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>Day</th>
                    <th>Open Time</th>
                    <th>Close Time</th>
                    <th>Quick Set</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for form in hours_fs %}
                  {% with day=form.day_of_week.value|default:'' %}
                  <tr class="hours-row {% if day|lower == now|date:'l'|lower %}table-info{% endif %}">
                    <td class="fw-bold">
                      {{ form.day_of_week|as_crispy_field }}
                    </td>
                    <td>
                      <input type="time" name="{{ form.open_time.html_name }}" id="{{ form.open_time.id_for_label }}" class="form-control open-time-input" value="{{ form.open_time.value|default:'' }}" {% if form.is_closed.value %}style="display:none;"{% endif %}>
                    </td>
                    <td>
                      <input type="time" name="{{ form.close_time.html_name }}" id="{{ form.close_time.id_for_label }}" class="form-control close-time-input" value="{{ form.close_time.value|default:'' }}" {% if form.is_closed.value %}style="display:none;"{% endif %}>
                    </td>
                    <td>
                      <div class="d-flex gap-1 justify-content-center align-items-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm set-closed-btn" title="Set Closed">Closed</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm set-24h-btn" title="Set 24h">24h</button>
                        <div class="form-check ms-2">
                          <input class="form-check-input is-closed-checkbox" type="checkbox" name="{{ form.is_closed.html_name }}" id="{{ form.is_closed.id_for_label }}" value="true" {% if form.is_closed.value %}checked{% endif %}>
                          <label class="form-check-label" for="{{ form.is_closed.id_for_label }}">Closed</label>
                        </div>
                      </div>
                    </td>
                    <td>
                      <button type="button" class="btn btn-outline-danger btn-sm clear-hours-btn" title="Clear this row">
                        <i class="bi bi-x-circle"></i> Clear
                      </button>
                    </td>
                  </tr>
                  {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="logo" role="tabpanel" aria-labelledby="logo-tab">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-image me-2"></i> Logo</h5>
          </div>
          <div class="card-body text-center">
            <img id="logoPreview" src="{{ rp_form.instance.logo.url|default:'https://via.placeholder.com/300x200.png?text=No+Logo' }}" class="img-fluid rounded mb-3 logo-preview" alt="Logo preview">
            <div class="mb-2">
              <i class="bi bi-info-circle text-primary" data-bs-toggle="tooltip" title="Recommended logo size: 300x200px. Supported formats: PNG, JPG. Transparent backgrounds look best."></i>
            </div>
            {{ rp_form.logo|as_crispy_field }}
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-header bg-white border-bottom-0 rounded-top-4">
            <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-geo-alt me-2"></i>Restaurant Location</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="new-address-input" class="form-label">Add New Address</label>
              <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip" title="Start typing and select an address from the dropdown. Only valid addresses are accepted."></i>
              <input type="text" id="new-address-input" class="form-control" placeholder="Type address or place">
              <button type="button" class="btn btn-outline-primary mt-2" id="add-address-btn">
                <i class="bi bi-geo-alt"></i> Add Address
              </button>
              <div id="feedback-message" class="mt-2 small feedback-message"></div>
            </div>
            <hr>
            <h6 class="text-muted mb-2">Saved Locations</h6>
            <ul id="address-list" class="list-group list-group-flush">
              {% if saved_addresses %}
                {% for address in saved_addresses %}
                  <li id="address-{{ address.id }}" class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="flex-grow-1 address-text">{{ address.formatted_address }}</span>
                    <input type="text" class="form-control d-none address-edit-input" value="{{ address.formatted_address }}">
                    <!-- Edit button removed -->
                    <button type="button" class="btn btn-outline-danger btn-sm delete-address-btn ms-2" data-address-id="{{ address.id }}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </li>
                {% endfor %}
              {% else %}
                <li id="no-addresses-alert" class="list-group-item text-muted">No addresses saved yet.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow-sm border-0 rounded-4 mt-4">
      <div class="card-body text-end">
        <button type="submit" class="btn btn-primary btn-lg px-4 d-none d-md-inline">
          <i class="bi bi-save me-2"></i> Save All Profile Changes
        </button>
      </div>
    </div>
    <!-- Sticky Save Button -->
    <button type="submit" form="restaurant-profile-form" class="btn btn-primary btn-lg px-4 position-fixed sticky-save-btn">
      <i class="bi bi-save me-2"></i> Save
    </button>
  </form>
</div>
{% endblock %}
{% block extra_js %}
  <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
  <script src="{% static 'js/restaurant_profile.js' %}"></script>
  <script src="{% static 'js/tooltips.js' %}"></script>
  <script>
  window.ADDRESS_LIST_CREATE_URL = "{% url 'locations:address-list-create' %}";
</script>
{% endblock %}