{% extends "base.html" %}
{% block title %}Restaurant Profile - Page Builder{% endblock %}
{% load static crispy_forms_tags %}
{% block extra_css %}
<!-- Add any specific CSS if needed -->
<style>
  #place-picker {
    width: 100%;
  }
</style>
{% endblock %}
{% block content %}
<script type="module" src="https://ajax.googleapis.com/ajax/libs/webcomponents/dist/webcomponents-loader.js"></script>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"></script>
<div class="container py-4">
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body p-4">
        <div class="d-flex flex-column flex-md-row align-items-center">
            <!-- Restaurant Logo -->
            <div class="me-md-4 mb-3 mb-md-0 text-center">
                <img class="rounded-3 border border-3 border-light shadow-sm" 
                     src="{{ rp_form.instance.logo.url|default:'/static/default_restaurant_logo.png' }}" 
                     alt="Restaurant Logo" 
                     style="width: 100px; height: 100px; object-fit: cover;">
            </div>
            <!-- Restaurant Info & Actions -->
            <div class="flex-grow-1 text-center text-md-start">
                <h3 class="fw-bold mb-1">{{ rp_form.instance.name|default:'Your Restaurant' }}</h3>
                <div class="text-muted mb-2">
                    <i class="bi bi-person-circle me-1"></i>Owner: {{ user.username }}
                </div>
                <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
                    <a href="{% url 'profile' %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Go back to your personal profile">
                        <i class="bi bi-arrow-left-circle"></i> View Personal Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
  </div>
  <form method="POST" enctype="multipart/form-data" autocomplete="off">
    {% csrf_token %}
    <div class="row g-4">
      <!-- Left Column for Details and Address -->
      <div class="col-lg-7">
        <!-- Restaurant Details (card) -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-header bg-white border-bottom-0 rounded-top-4 d-flex align-items-center">
              <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-info-circle me-2"></i> Restaurant Details</h5>
            </div>
            <div class="card-body">
              {% for field in rp_form %}{% if field.name != "logo" %}{{ field|as_crispy_field }}{% endif %}{% endfor %}
              </div>
            </div>
            <!-- Social Links -->
            <div class="card shadow-sm border-0 rounded-4 mb-4">
              <div class="card-header bg-white border-bottom-0 rounded-top-4">
                <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-share me-2"></i> Social Links</h5>
              </div>
              <div class="card-body">
                {{ social_fs.management_form }}
                {% for form in social_fs %}
                  <div class="row g-3 mb-2 align-items-center">
                    <div class="col-md-5">{{ form.name|as_crispy_field }}</div>
                    <div class="col-md-7">{{ form.url|as_crispy_field }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <!-- Opening Hours -->
            <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-white border-bottom-0 rounded-top-4">
              <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-clock me-2"></i> Opening Hours</h5>
            </div>
            <div class="card-body">
              {{ hours_fs.management_form }}
              {% for form in hours_fs %}
                <div class="row g-3 mb-2 align-items-center">
                  <div class="col-md-4">{{ form.day_of_week|as_crispy_field }}</div>
                  <div class="col-md-4">{{ form.open_time|as_crispy_field }}</div>
                  <div class="col-md-4">{{ form.close_time|as_crispy_field }}</div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-5">
          <!-- Logo -->
          <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-header bg-white border-bottom-0 rounded-top-4">
              <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-image me-2"></i> Logo</h5>
            </div>
            <div class="card-body text-center">
              <img id="logoPreview" src="{{ rp_form.instance.logo.url|default:'https://via.placeholder.com/300x200.png?text=No+Logo' }}" class="img-fluid rounded mb-3" style="max-height: 250px; object-fit: cover;" alt="Logo preview">
              {{ rp_form.logo|as_crispy_field }}
            </div>
          </div>
          <!-- Address Management -->
          <div class="card shadow-sm border-0 rounded-4">
              <div class="card-header bg-white border-bottom-0 rounded-top-4">
                  <h5 class="mb-0 py-2 fs-5 text-primary-emphasis"><i class="bi bi-geo-alt me-2"></i> Delivery Addresses</h5>
              </div>
              <div class="card-body">
                  <gmpx-api-loader key="{{ GOOGLE_MAPS_API_KEY }}"></gmpx-api-loader>
                  <gmpx-place-picker id="place-picker" placeholder="Enter an address to add"></gmpx-place-picker>
                  <div id="feedback-message" class="mt-2 small" style="min-height: 20px;"></div>
                  <hr>
                  <h6 class="text-muted mb-2">Saved Locations</h6>
                  <ul id="address-list" class="list-group list-group-flush">
                    {% if saved_addresses %}
                      {% for address in saved_addresses %}
                        <li id="address-{{ address.id }}" class="list-group-item d-flex justify-content-between align-items-center">
                          <span class="flex-grow-1">{{ address.formatted_address }}</span>
                          <button type="button" class="btn btn-outline-danger btn-sm delete-address-btn ms-2" data-address-id="{{ address.id }}">
                            <i class="bi bi-trash"></i>
                          </button>
                        </li>
                      {% endfor %}
                    {% else %}
                      <li id="no-addresses-alert" class="list-group-item text-muted">No addresses saved yet.</li>
                    {% endif %}
                  </ul>
              </div>
          </div>
        </div>

        <!-- Save All Button -->
        <div class="col-12">
          <div class="card shadow-sm border-0 rounded-4 mt-4">
            <div class="card-body text-end">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                <i class="bi bi-save me-2"></i> Save All Profile Changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  {% endblock %}

{% block extra_js %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // logo preview
  const logoInput = document.querySelector('[name="logo"]');
  if (logoInput) {
    logoInput.addEventListener('change', function(event) {
      const preview = document.getElementById('logoPreview');
      const file = event.target.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
      }
    });
  }

  // --- Address Management ---
  const placePicker = document.getElementById('place-picker');
  const feedbackMessage = document.getElementById('feedback-message');
  const addressList = document.getElementById('address-list');

  // When a user picks a place, try to save it immediately.
  placePicker.addEventListener('gmpx-placechange', () => {
    const selectedPlace = placePicker.value;
    if (selectedPlace?.location) {
      saveAddress(selectedPlace);
    }
  });

  async function saveAddress(place) {
    feedbackMessage.innerHTML = '<span class="text-primary">Saving address...</span>';
    const data = {
      formatted_address: place.formattedAddress,
      latitude: place.location.lat(),
      longitude: place.location.lng()
    };

    try {
      const response = await fetch("{% url 'locations:address-list-create' %}", {
        method: "POST",
        headers: {"Content-Type": "application/json", "X-CSRFToken": csrftoken},
        body: JSON.stringify(data)
      });

      if (response.ok) {
        const newAddress = await response.json();
        addAddressToList(newAddress);
        feedbackMessage.innerHTML = '<span class="text-success">Address added!</span>';
        placePicker.value = null; // Clear picker
      } else {
        const errorText = await response.text();
        feedbackMessage.innerHTML = `<span class="text-danger">Error: ${errorText}</span>`;
      }
    } catch (error) {
      feedbackMessage.innerHTML = '<span class="text-danger">A network error occurred.</span>';
      console.error("Save address error:", error);
    }
  }

  function addAddressToList(address) {
    document.getElementById('no-addresses-alert')?.remove();

    const li = document.createElement('li');
    li.id = `address-${address.id}`;
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <span class="flex-grow-1">${address.formatted_address}</span>
      <button type="button" class="btn btn-outline-danger btn-sm delete-address-btn ms-2" data-address-id="${address.id}">
        <i class="bi bi-trash"></i>
      </button>
    `;
    addressList.appendChild(li);

    new bootstrap.Tooltip(li.querySelector('.delete-address-btn'));
  }

  // Event delegation for deleting an address
  addressList.addEventListener('click', async function(event) {
    const deleteButton = event.target.closest('.delete-address-btn');
    if (!deleteButton) return;

    const addressId = deleteButton.dataset.addressId;
    const urlTemplate = "{% url 'locations:address-delete' pk=0 %}";
    const url = `/locations/api/addresses/${addressId}/delete/`;

    if (!confirm('Are you sure you want to delete this address?')) return;

    try {
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {'X-CSRFToken': csrftoken}
      });

      if (response.ok) {
        document.getElementById(`address-${addressId}`).remove();
        if (addressList.children.length === 0) {
            addressList.innerHTML = '<li id="no-addresses-alert" class="list-group-item text-muted">No addresses saved yet.</li>';
        }
      } else {
        const errorData = await response.json();
        alert(`Failed to delete address: ${errorData.message || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Delete address error:', error);
      alert('A network error occurred while trying to delete the address.');
    }
  });
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
});
</script>
{% endblock %}