{% extends "base.html" %}
{% load math_filters %}
{% block title %}Order #{{ order.id }} Details{% endblock %}
{% block extra_css %}
<style>
  .order-detail-card {
    border-radius: 18px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    background: #fff;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .order-status {
    font-weight: 600;
    border-radius: 8px;
    padding: 0.35em 0.8em;
    font-size: 0.98rem;
    display: inline-block;
  }
  .order-status.pending { background: #ffe082; color: #7c6f00; }
  .order-status.completed { background: #c8e6c9; color: #256029; }
  .order-status.cancelled { background: #ffcdd2; color: #b71c1c; }
  .order-status.in_progress { background: #bbdefb; color: #0d47a1; }
  .order-items-table th, .order-items-table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    font-size: 1.05rem;
  }
  .order-items-table th {
    background: #f5f5f5;
    font-weight: 600;
    color: #222;
    border-bottom: 2px solid #eee;
  }
  .order-items-table tbody tr:hover {
    background: #f8f9fa;
  }
</style>
{% endblock %}
{% block content %}

<div class="container py-5">
  <div id="print-area">
    <h1 class="fw-bold mb-4 text-center">Order #{{ order.id }} Details</h1>
    <div class="order-detail-card">
      <div class="row mb-3">
        <div class="col-md-6">
          <h5>Customer</h5>
          <p class="mb-1 fw-bold">{{ order.customer.username }}</p>
          <p class="mb-1"><strong>Phone:</strong> {{ order.phone_number|default:"-" }}</p>
          <h5>Delivery / Pickup</h5>
          <p>
            {% if order.delivery_address %}
              <strong>Delivery Address:</strong> {{ order.delivery_address }}
            {% else %}
              <strong>Pickup at restaurant</strong>
            {% endif %}
          </p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5>Status</h5>
          <span class="order-status {{ order.status|lower|slugify }}">{{ order.get_status_display }}</span>
          <p class="mb-1 mt-2"><strong>Date:</strong> {{ order.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
        </div>
      </div>
      <h5 class="mt-4">Items</h5>
      <div class="table-responsive">
        <table class="table order-items-table">
          <thead>
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Qty</th>
              <th scope="col">Unit Price</th>
              <th scope="col">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.order_items.all %}
            <tr>
              <td>{{ item.menu_item.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.price|floatformat:2 }} €</td>
              <td>{{ item.price|mul:item.quantity|floatformat:2 }} €</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">No items found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <h5>Delivery / Pickup</h5>
          <p>
            {% if order.delivery_address %}
              <strong>Delivery Address:</strong> {{ order.delivery_address }}
            {% else %}
              <strong>Pickup at restaurant</strong>
            {% endif %}
          </p>
          <h5>Payment Method</h5>
          <p>
            {% if order.pay_method %}
              <strong>{{ order.pay_method }}</strong>
            {% else %}
              <span class="text-muted">Not specified</span>
            {% endif %}
          </p>
          <h5>Special Instructions</h5>
          <p>{{ order.special_instructions|default:"-" }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5 class="mb-1">Total</h5>
          <p class="fs-4 fw-bold">{{ order.total_price|floatformat:2 }} €</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex align-items-center mt-3">
  <!-- Status Dropdown Form -->
  <form method="post" action="" class="me-3" id="statusForm">
    {% csrf_token %}
    <label for="statusDropdown" class="me-2 fw-bold">Status:</label>
    <select name="status" id="statusDropdown" class="form-select form-select-sm d-inline-block w-auto">
      {% for key, value in order.STATUS_CHOICES %}
        <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>{{ value }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="order_id" value="{{ order.id }}">
    <button type="submit" class="btn btn-outline-secondary btn-sm ms-2">Update</button>
  </form>
  <!-- Print Button -->
  <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#printModal" id="printOrderBtn">
    Print Order
  </button>
</div>
</div>
<style>
@media print {
  body * { visibility: hidden !important; }
  #print-area, #print-area * { visibility: visible !important; }
  #print-area { position: absolute; left: 0; top: 0; width: 100vw; background: #fff; z-index: 9999; }
}
</style>

<!-- Print Modal -->

<div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="printModalLabel">Print Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Click the button below to open the print dialog and select your printer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmPrintBtn">Print</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var printBtn = document.getElementById('confirmPrintBtn');
    var statusDropdown = document.getElementById('statusDropdown');
    var statusForm = document.getElementById('statusForm');
    if (printBtn) {
      printBtn.addEventListener('click', function() {
        // Before printing, set status to Confirmed if not already
        if (statusDropdown && statusDropdown.value !== 'confirmed') {
          statusDropdown.value = 'confirmed';
          if (statusForm) {
            statusForm.submit();
          }
        }
        // Hide modal before printing
        var modal = document.getElementById('printModal');
        if (modal) {
          var modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) modalInstance.hide();
        }
        setTimeout(function() {
          window.print();
        }, 300);
      });
    }
  });
</script>
</div>
{% endblock %}
