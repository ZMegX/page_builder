{% extends "base.html" %}
{% load static %}
{% load math_filters %}
{% block title %}Order #{{ order.id }} Details{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/restaurant-order-detail.css' %}">
{% endblock %}
{% block header %}
<div class="order-detail-header">
  <div class="container-fluid">
    <div class="header-content">
      <!-- Left Section: Order Info -->
      <div class="header-left">
        <div class="order-badge">
          <i class="bi bi-receipt-cutoff"></i>
          <span class="order-number">Order #{{ order.id }}</span>
        </div>
        <div class="order-meta">
          <span class="order-date">
            <i class="bi bi-calendar3"></i>
            {{ order.created_at|date:"M d, Y" }}
          </span>
          <span class="order-time">
            <i class="bi bi-clock"></i>
            {{ order.created_at|time:"g:i A" }}
          </span>
        </div>
      </div>

      <!-- Center Section: Status Control -->
      <div class="header-center">
        <form method="post" action="" id="statusForm">
          {% csrf_token %}
          <div class="status-control">
            <label for="statusDropdown" class="status-label">
              <i class="bi bi-circle-fill"></i>
              Order Status
            </label>
            <div class="status-input-group">
              <select name="status" id="statusDropdown" class="form-select status-select">
                {% for key, value in order.STATUS_CHOICES %}
                  <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <button type="submit" class="btn-update">
                <i class="bi bi-check-circle"></i>
                Update
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Right Section: Actions -->
      <div class="header-right">
        <button type="button" class="btn-action btn-print" data-bs-toggle="modal" data-bs-target="#printModal">
          <i class="bi bi-printer-fill"></i>
          <span>Print</span>
        </button>
        <a href="{% url 'restaurant_orders_list' %}" class="btn-action btn-back">
          <i class="bi bi-arrow-left"></i>
          <span>Back to Orders</span>
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Print Modal -->
<div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="printModalLabel">Print Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Click the button below to open the print dialog and select your printer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmPrintBtn">Print</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block content %}
<div class="container py-5">
  <div id="print-area">
    <h1 class="fw-bold mb-4 text-center">Order #{{ order.id }} Details</h1>
    <div class="order-detail-card restaurant-order-detail">
      <div class="row mb-3">
        <div class="col-md-6">
          <h5>Customer</h5>
          <p class="mb-1 fw-bold">{{ order.customer.username }}</p>
          <p class="mb-1"><strong>Phone:</strong> {{ order.phone_number|default:"-" }}</p>
          <h5>Delivery / Pickup</h5>
          <p>
            {% if order.delivery_address %}
              <strong>Delivery Address:</strong> {{ order.delivery_address }}
            {% else %}
              <strong>Pickup at restaurant</strong>
            {% endif %}
          </p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5>Status</h5>
          <span class="order-status restaurant-order-detail {{ order.status|lower|slugify }}">{{ order.get_status_display }}</span>
          <p class="mb-1 mt-2"><strong>Date:</strong> {{ order.created_at|date:"SHORT_DATETIME_FORMAT" }}</p>
        </div>
      </div>
      <h5 class="mt-4">Items</h5>
      <div class="table-responsive">
        <table class="table order-items-table restaurant-order-detail">
          <thead>
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Qty</th>
              <th scope="col">Unit Price</th>
              <th scope="col">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.order_items.all %}
            <tr>
              <td>{{ item.menu_item.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ item.price|floatformat:2 }} €</td>
              <td>{{ item.price|mul:item.quantity|floatformat:2 }} €</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">No items found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <h5>Delivery / Pickup</h5>
          <p>
            {% if order.delivery_address %}
              <strong>Delivery Address:</strong> {{ order.delivery_address }}
            {% else %}
              <strong>Pickup at restaurant</strong>
            {% endif %}
          </p>
          <h5>Payment Method</h5>
          <p>
            {% if order.pay_method %}
              <strong>{{ order.pay_method }}</strong>
            {% else %}
              <span class="text-muted">Not specified</span>
            {% endif %}
          </p>
          <h5>Special Instructions</h5>
          <p>{{ order.special_instructions|default:"-" }}</p>
        </div>
        <div class="col-md-6 text-md-end">
          <h5 class="mb-1">Total</h5>
          <p class="fs-4 fw-bold">{{ order.total_price|floatformat:2 }} €</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/restaurantOrderDetail.js' %}"></script>
{% endblock %}