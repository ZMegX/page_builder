{% extends "base.html" %}
{% load static %}
{% block title %}Orders Management - Restaurant{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/restaurant-order-list.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}
{% block header %}
<div class="orders-page-header">
  <div class="container-fluid">
    <div class="header-content">
      <!-- Left Section: Title & Description -->
      <div class="header-left">
        <div class="header-title-group">
          <h1>
            <i class="bi bi-receipt-cutoff"></i>
            Orders Management
          </h1>
          <p class="subtitle">Manage and track all your restaurant orders</p>
        </div>
        <div class="header-stats-mini">
          <span class="stat-mini">
            <i class="bi bi-receipt"></i>
            {{ orders|length }} Total
          </span>
          <span class="stat-mini">
            <i class="bi bi-clock-history"></i>
            Today
          </span>
        </div>
      </div>

      <!-- Right Section: Actions -->
      <div class="header-right">
        <button type="button" class="btn-action btn-print" onclick="window.print()">
          <i class="bi bi-printer-fill"></i>
          <span>Print</span>
        </button>
        <a href="{% url 'restaurant_profile' %}" class="btn-action btn-back">
          <i class="bi bi-arrow-left"></i>
          <span>Back to Profile</span>
        </a>
      </div>
    </div>
  </div>
</div>
<!-- Stats Cards -->
<div class="container-fluid px-4">
  <div class="orders-stats">
    <div class="stat-card pending">
      <div class="stat-icon">
        <i class="bi bi-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{{ pending_count }}</div>
      </div>
    </div>
    <div class="stat-card in-progress">
      <div class="stat-icon">
        <i class="bi bi-hourglass-split"></i>
      </div>
      <div class="stat-content">
        <div class="stat-label">In Progress</div>
        <div class="stat-value">{{ in_progress_count }}</div>
      </div>
    </div>
    <div class="stat-card completed">
      <div class="stat-icon">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-label">Completed</div>
        <div class="stat-value">{{ completed_count }}</div>
      </div>
    </div>
    <div class="stat-card cancelled">
      <div class="stat-icon">
        <i class="bi bi-x-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-label">Cancelled</div>
        <div class="stat-value">{{ cancelled_count }}</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block content %}
<div class="container-fluid px-4 py-4">
  <!-- Main Orders Container -->
  <div class="restaurant-orders-container">
    <!-- Filter Bar -->
    <div class="orders-filter-bar">
      <div class="row g-3">
        <div class="col-md-6 col-lg-4">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control border-start-0" placeholder="Search by order ID or customer...">
          </div>
        </div>
        <div class="col-md-3 col-lg-2">
          <select class="form-select">
            <option selected>All Status</option>
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="col-md-3 col-lg-2">
          <select class="form-select">
            <option selected>Sort by Date</option>
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="price_high">Price: High to Low</option>
            <option value="price_low">Price: Low to High</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Card Header -->
    <div class="orders-card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-list-ul me-2"></i>Order List</h2>
        <span class="badge bg-primary rounded-pill fs-6">{{ orders|length }} order{{ orders|length|pluralize }}</span>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="card-body p-0">
      {% if orders %}
        <div class="table-responsive">
          <table class="table order-table restaurant-order-list mb-0">
            <thead>
              <tr>
                <th scope="col"><i class="bi bi-hash me-1"></i>Order ID</th>
                <th scope="col"><i class="bi bi-person me-1"></i>Customer</th>
                <th scope="col"><i class="bi bi-circle-fill me-1"></i>Status</th>
                <th scope="col"><i class="bi bi-currency-euro me-1"></i>Total</th>
                <th scope="col"><i class="bi bi-calendar me-1"></i>Date & Time</th>
                <th scope="col"><i class="bi bi-chat-left-text me-1"></i>Instructions</th>
                <th scope="col"><i class="bi bi-gear me-1"></i>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for order in orders %}
              <tr>
                <!-- Order ID -->
                <td>
                  <a href="{% url 'restaurant_order_detail' order.id %}" class="order-id-badge">
                    <i class="bi bi-receipt"></i>
                    #{{ order.id }}
                  </a>
                </td>

                <!-- Customer Info -->
                <td>
                  <div class="customer-info">
                    <div class="customer-avatar">
                      {{ order.customer.username|slice:":1"|upper }}
                    </div>
                    <div class="customer-details">
                      <div class="customer-name">{{ order.customer.username }}</div>
                      <div class="customer-email">{{ order.customer.email|default:"No email" }}</div>
                    </div>
                  </div>
                </td>

                <!-- Status -->
                <td>
                  <div class="order-status-wrapper">
                    <!-- Status Display Badge -->
                    <span class="order-status restaurant-order-list {{ order.status|lower|slugify }}">
                      {% if order.status == 'pending' %}
                        <i class="bi bi-clock-fill"></i>
                      {% elif order.status == 'in_progress' %}
                        <i class="bi bi-hourglass-split"></i>
                      {% elif order.status == 'completed' %}
                        <i class="bi bi-check-circle-fill"></i>
                      {% elif order.status == 'cancelled' %}
                        <i class="bi bi-x-circle-fill"></i>
                      {% endif %}
                      {{ order.get_status_display }}
                    </span>
                    
                    <!-- Status Update Dropdown -->
                    <form method="post" action="{% url 'restaurant_orders_list' %}" class="m-0">
                      {% csrf_token %}
                      <select name="status" class="form-select form-select-sm order-status-dropdown" onchange="this.form.submit()">
                        {% for key, value in order.STATUS_CHOICES %}
                          <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                      </select>
                      <input type="hidden" name="order_id" value="{{ order.id }}">
                    </form>
                  </div>
                </td>

                <!-- Total Price -->
                <td>
                  <div class="order-price">â‚¬{{ order.total_price|floatformat:2 }}</div>
                </td>

                <!-- Date & Time -->
                <td>
                  <div class="order-datetime">
                    <div class="order-date">
                      <i class="bi bi-calendar3 me-1"></i>
                      {{ order.created_at|date:"M d, Y" }}
                    </div>
                    <div class="order-time">
                      <i class="bi bi-clock me-1"></i>
                      {{ order.created_at|time:"g:i A" }}
                    </div>
                  </div>
                </td>

                <!-- Special Instructions -->
                <td>
                  {% if order.special_instructions %}
                    <div class="order-instructions" title="{{ order.special_instructions }}">
                      <i class="bi bi-chat-left-quote me-1"></i>
                      {{ order.special_instructions }}
                    </div>
                  {% else %}
                    <span class="order-instructions empty">
                      <i class="bi bi-dash-circle me-1"></i>
                      None
                    </span>
                  {% endif %}
                </td>

                <!-- Actions -->
                <td>
                  <div class="order-actions">
                    <a href="{% url 'restaurant_order_detail' order.id %}" class="btn-order-view">
                      <i class="bi bi-eye-fill"></i>
                      View Details
                    </a>
                    <button class="btn-order-action" title="Print Order" onclick="window.print()">
                      <i class="bi bi-printer"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="orders-empty-state">
          <i class="bi bi-inbox"></i>
          <h3>No Orders Yet</h3>
          <p>When customers place orders, they will appear here.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
{% if messages %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}x-circle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  // Auto-hide alerts after 5 seconds
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      var alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        var bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      });
    }, 5000);
  });

  // Search functionality (frontend filter)
  document.querySelector('.form-control[placeholder*="Search"]').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.restaurant-order-list tbody tr');
    
    rows.forEach(function(row) {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
</script>
{% endblock %}
