{% extends "base.html" %}
{% block body_class %}{{ profile.theme_choice }}-theme{% endblock %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'themes/theme-' %}{{ profile.theme_choice }}.css">
<link rel="stylesheet" href="{% static 'css/menu_custom.css' %}">
{% endblock %}
{% load cloudinary %}
{% block title %}{{ profile.name }} — Menu{% endblock %}

<div class="menu-bg-overlay"></div>
  {% block content %}
  <div class="container py-4">
    <div class="mb-3">
      <a href="{% url 'webpage_restaurant_site:landing' slug=profile.slug %}" class="btn btn-outline-secondary">
        &larr; Back to Restaurant
      </a>
    </div>
    <div class="mb-3">
      {% if not user.is_authenticated %}
        <div class="alert alert-info text-center mb-4">
          To order, please <a href="{% url 'login' %}">log in</a> or <a href="{% url 'register' %}">sign up</a>.
        </div>
      {% endif %}
    </div>
    <section class="menu-selection-card mb-5">
      <div class="row g-0 align-items-stretch">
        <!-- Left Column: Restaurant Details -->
        <div class="col-lg-6 d-flex flex-column justify-content-between p-4">
          <div>
            <div class="d-flex align-items-center mb-3">
              {% if profile.logo %}
                <img src="{{ profile.logo.url }}" class="img-fluid rounded shadow-sm me-3 logo-animate" style="max-height: 80px; border: 4px solid #fff;" alt="{{ profile.name }} logo">
              {% endif %}
              <div>
                <h1 class="display-6 mb-0">{{ profile.name }}</h1>
                {% if status.open_now %}
                  <span class="badge text-bg-success ms-auto">Open now</span>
                {% else %}
                  <span class="badge text-bg-secondary ms-auto">Closed</span>
                {% endif %}
              </div>
            </div>
            <div class="mb-2">
              {% if profile.cuisine_type %}
                <div class="mb-2">
                  <i class="bi bi-egg-fried me-2 text-muted"></i>
                  <strong>Cuisine:</strong> {{ profile.cuisine_type }}
                </div>
              {% endif %}
              {% if profile.phone_number %}
                <div class="mb-2">
                  <i class="bi bi-telephone me-2 text-muted"></i>
                  <strong>Phone:</strong> <a href="tel:{{ profile.phone_number }}">{{ profile.phone_number }}</a>
                </div>
              {% endif %}
              {% if address.formatted_address %}
                <div class="mb-2">
                  <i class="bi bi-geo-alt me-2 text-muted"></i>
                  <strong>Address:</strong> {{ address.formatted_address }}
                </div>
              {% endif %}
            </div>
            {% if profile.social_links.all %}
              <section class="mt-auto pt-3">
                <strong>Follow us:</strong>
                <div class="d-flex gap-2 mt-2 flex-wrap">
                  {% for sl in profile.social_links.all %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ sl.url }}" target="_blank" rel="noopener">
                      <i class="bi bi-box-arrow-up-right me-1"></i>{{ sl.name }}
                    </a>
                  {% endfor %}
                </div>
              </section>
            {% endif %}
          </div>
        </div>
        <!-- Right Column: Map -->
        <div class="col-lg-6 p-3">
          <div class="h-100 w-100 d-flex align-items-center justify-content-center">
            {% if address and map_center.lat and map_center.lng and GOOGLE_MAPS_API_KEY %}
              <div id="menu-map" class="rounded w-100" style="height: 320px;"></div>
            {% else %}
              <div class="p-5 h-100 d-flex justify-content-center align-items-center text-center text-muted">
                <div>
                  <i class="bi bi-geo-alt" style="font-size: 2.5rem;"></i>
                  <div class="mt-2">No address has been set for this restaurant.</div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
    <!-- Desktop/tablet layout -->
    <div class="d-none d-md-block">
      <ul class="nav nav-tabs nav-justified mb-4" id="desktopMenuTabs" role="tablist">
        {% for menu in menus %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" id="desktop-menu-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#desktop-menu-pane-{{ forloop.counter }}" type="button" role="tab" aria-controls="desktop-menu-pane-{{ forloop.counter }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ menu.name }}</button>
          </li>
        {% endfor %}
      </ul>
      <div class="tab-content" id="desktopMenuTabContent">
        {% for menu in menus %}
          <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="desktop-menu-pane-{{ forloop.counter }}" role="tabpanel" aria-labelledby="desktop-menu-tab-{{ forloop.counter }}">
            <div class="menu-modern-list">
              {% for item in menu.items.all %}
                <div class="menu-modern-row d-flex align-items-center py-3 px-2 mb-2 menu-item-row" style="border-radius: 1rem; background: #fff; cursor:pointer;" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" data-item-price="{{ item.price|floatformat:2 }}" data-item-img="{% if item.image %}{% cloudinary_url item.image.public_id width=300 height=200 crop='fill' gravity='auto' %}{% else %}{% static 'default_profile_pic.png' %}{% endif %}" data-item-ingredients="{{ item.ingredients|default:'' }}">
                  <div class="menu-modern-item-img me-3" style="flex: 0 0 60px;">
                    <img src="{% if item.image %}{% cloudinary_url item.image.public_id width=60 height=60 crop='fill' gravity='auto' %}{% else %}{% static 'default_profile_pic.png' %}{% endif %}"
                        alt="{{ item.name }}"
                        style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.7rem; box-shadow: 0 2px 8px #eee;">
                  </div>
                  <div class="menu-modern-item-info flex-grow-1">
                    <div class="menu-modern-item-name" style="font-weight:700; font-size:1.1rem;">{{ item.name }}</div>
                  </div>
                  <div class="menu-modern-item-actions ms-3 d-flex align-items-center gap-2">
                    <div class="menu-modern-item-price pe-4">
                      €{{ item.price|floatformat:2 }}
                    </div>
                    <form method="post" action="{% url 'webpage_restaurant_site:add_to_cart' item.id %}" class="add-to-cart-form">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-primary">Add to Cart</button>
                    </form>
                  </div>
                </div>
              {% empty %}
                <div class="text-muted text-center py-4">This menu currently has no items.</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <!-- Menu Items Section -->
    <!-- Responsive tabs for menu sections (mobile only) -->
    <div class="d-md-none mb-4">
      <ul class="nav nav-tabs nav-justified" id="menuTabs" role="tablist">
        {% for menu in menus %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" id="menu-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#menu-pane-{{ forloop.counter }}" type="button" role="tab" aria-controls="menu-pane-{{ forloop.counter }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ menu.name }}</button>
          </li>
        {% endfor %}
      </ul>
      <div class="tab-content pt-3" id="menuTabContent">
        {% for menu in menus %}
          <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="menu-pane-{{ forloop.counter }}" role="tabpanel" aria-labelledby="menu-tab-{{ forloop.counter }}">
            <div class="row g-3">
              {% for item in menu.items.all %}
                <div class="col-12">
                  <div class="card h-100 shadow-sm border-0 menu-item-row" style="cursor:pointer;" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}" data-item-price="{{ item.price|floatformat:2 }}" data-item-img="{% if item.image %}{% cloudinary_url item.image.public_id width=300 height=200 crop='fill' gravity='auto' %}{% else %}{% static 'default_profile_pic.png' %}{% endif %}" data-item-ingredients="{{ item.ingredients|default:'' }}">
                    <div class="row g-0 align-items-center">
                      <div class="col-4">
                        <img src="{% if item.image %}{% cloudinary_url item.image.public_id width=80 height=80 crop='fill' gravity='auto' %}{% else %}{% static 'default_profile_pic.png' %}{% endif %}" alt="{{ item.name }}" class="img-fluid rounded">
                      </div>
                      <div class="col-5 text-center">
                        <div class="fw-bold">{{ item.name }}</div>
                        <div class="text-primary fw-bold">€{{ item.price|floatformat:2 }}</div>
                      </div>
                      <div class="col-3 text-end pe-4">
                        <form method="post" action="{% url 'webpage_restaurant_site:add_to_cart' item.id %}" class="add-to-cart-form">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-success">Add</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="col-12 text-center text-muted">No items in this section.</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
// Enable modal logic for all devices
  document.addEventListener('DOMContentLoaded', function() {
    var modal = new bootstrap.Modal(document.getElementById('menuItemModal'));
    var modalLabel = document.getElementById('menuItemModalLabel');
    var modalImg = document.getElementById('modalItemImg');
    var modalIngredients = document.getElementById('modalItemIngredients');
    var modalPrice = document.getElementById('modalItemPrice');
    var modalForm = document.getElementById('modalAddToCartForm');
    document.querySelectorAll('.menu-item-row').forEach(function(row) {
      row.addEventListener('click', function(e) {
        // Prevent opening modal if Add to Cart button is clicked
        if (e.target.closest('.add-to-cart-form')) return;
        modalLabel.textContent = row.getAttribute('data-item-name');
        modalImg.src = row.getAttribute('data-item-img');
        modalImg.alt = row.getAttribute('data-item-name');
        var ingredients = row.getAttribute('data-item-ingredients');
        modalIngredients.textContent = ingredients ? ingredients : '';
        modalPrice.textContent = '€' + row.getAttribute('data-item-price');
        modalForm.action = '/menu/add-to-cart/' + row.getAttribute('data-item-id') + '/';
        modal.show();
      });
    });
  });

</script>
{% if address and map_center.lat and map_center.lng and GOOGLE_MAPS_API_KEY %}
<script>
  function initMenuMap() {
    var lat = parseFloat("{{ map_center.lat }}");
    var lng = parseFloat("{{ map_center.lng }}");
    var mapDiv = document.getElementById("menu-map");
    if (!mapDiv) return;
    var map = new google.maps.Map(mapDiv, {
      zoom: 15,
      center: {lat: lat, lng: lng},
      mapTypeControl: false,
      streetViewControl: false
    });
    // Use AdvancedMarkerElement if available, fallback to Marker
    if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
      new google.maps.marker.AdvancedMarkerElement({
        map: map,
        position: {lat: lat, lng: lng},
        title: "{{ profile.name|escapejs }}"
      });
    } else {
      new google.maps.Marker({
        position: {lat: lat, lng: lng},
        map: map,
        title: "{{ profile.name|escapejs }}"
      });
    }
  }
  // Google Maps API will call this when loaded
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMenuMap"></script>
{% endif %}
<!-- Menu Item Modal (required for JS to work) -->
<div class="modal fade" id="menuItemModal" tabindex="-1" aria-labelledby="menuItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="menuItemModalLabel">Item Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <img id="modalItemImg" src="/static/default_profile_pic.png" alt="Menu item image" class="img-fluid rounded mb-3">
        <div class="mb-2"><strong>Ingredients:</strong> <span id="modalItemIngredients"></span></div>
        <div class="mb-2"><strong>Price:</strong> <span id="modalItemPrice"></span></div>
          <form id="modalAddToCartForm" method="post" action="#">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary w-100">Add to Cart</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}