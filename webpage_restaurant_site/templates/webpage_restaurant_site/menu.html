{% extends "base.html" %}
{% load static %}
{% load cloudinary %}
{% block title %}{{ profile.name }} â€” Menu{% endblock %}
{% block extra_css %}
<style>
  .menu-guest-container {
    max-width: 480px;
    margin: 0 auto;
    padding-top: 48px;
  }
  .menu-guest-card {
    border-radius: 1.2rem;
    box-shadow: 0 2px 16px rgba(0,0,0,0.07);
    background: #fff;
    padding: 2.5rem 2rem;
    margin-bottom: 2rem;
    border: none;
  }
  .menu-guest-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .menu-guest-logo {
    max-width: 120px;
    max-height: 120px;
    border-radius: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  }
  .menu-guest-title {
    font-size: 2rem;
    font-weight: 700;
    color: #222;
    margin-bottom: 0.5rem;
  }
  .menu-guest-badge {
    font-size: 1rem;
    border-radius: 1rem;
    padding: 0.3rem 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  .menu-guest-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #007bff;
    margin-bottom: 1rem;
    margin-top: 2rem;
  }
  .menu-guest-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #f0f0f0;
  }
  .menu-guest-item:last-child {
    border-bottom: none;
  }
  .menu-guest-item-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 0.7rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    background: #f8f9fa;
  }
  .menu-guest-item-info {
    flex: 1;
  }
  .menu-guest-item-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: #222;
  }
  .menu-guest-item-desc {
    font-size: 0.98rem;
    color: #555;
    margin-bottom: 0.2rem;
  }
  .menu-guest-item-price {
    font-size: 1.08rem;
    font-weight: 700;
    color: #007bff;
    margin-left: 0.5rem;
  }
  /* Map container style */
  #menu-map {
    height: 240px;
    margin-top: 0.5rem;
    border-radius: 1rem;
  }
</style>
{% endblock %}

{% block content %}

<div class="container py-4">
  <pre style="background:#f8f9fa; color:#333; padding:8px; border-radius:6px; font-size:0.95em;">
    address: {{ address }}
    lat: {{ map_center.lat }}
    lng: {{ map_center.lng }}
    key: {{ GOOGLE_MAPS_API_KEY }}
  </pre>
  <div class="mb-3">
    <a href="{% url 'webpage_restaurant_site:landing' slug=profile.slug %}" class="btn btn-outline-secondary">
      &larr; Back to Restaurant
    </a>
  </div>
  <div class="card shadow-lg border-0 rounded-4 mb-5 bg-light">
    <div class="row g-0 align-items-stretch">
      <!-- Left Column: Restaurant Details -->
      <div class="col-lg-6 d-flex flex-column justify-content-between p-4">
        <div>
          <div class="d-flex align-items-center mb-3">
            {% if profile.logo %}
              <img src="{{ profile.logo.url }}" class="img-fluid rounded shadow-sm me-3 logo-animate" style="max-height: 80px; border: 4px solid #fff;" alt="{{ profile.name }} logo">
            {% endif %}
            <div>
              <h1 class="display-6 mb-0">{{ profile.name }}</h1>
              {% if status.open_now %}
                <span class="badge text-bg-success ms-auto">Open now</span>
              {% else %}
                <span class="badge text-bg-secondary ms-auto">Closed</span>
              {% endif %}
            </div>
          </div>
          <div class="mb-2">
            {% if profile.cuisine_type %}
              <div class="mb-2">
                <i class="bi bi-egg-fried me-2 text-muted"></i>
                <strong>Cuisine:</strong> {{ profile.cuisine_type }}
              </div>
            {% endif %}
            {% if profile.phone_number %}
              <div class="mb-2">
                <i class="bi bi-telephone me-2 text-muted"></i>
                <strong>Phone:</strong> <a href="tel:{{ profile.phone_number }}">{{ profile.phone_number }}</a>
              </div>
            {% endif %}
            {% if address.formatted_address %}
              <div class="mb-2">
                <i class="bi bi-geo-alt me-2 text-muted"></i>
                <strong>Address:</strong> {{ address.formatted_address }}
              </div>
            {% endif %}
          </div>
          {% if profile.social_links.all %}
            <section class="mt-auto pt-3">
              <strong>Follow us:</strong>
              <div class="d-flex gap-2 mt-2 flex-wrap">
                {% for sl in profile.social_links.all %}
                  <a class="btn btn-sm btn-outline-secondary" href="{{ sl.url }}" target="_blank" rel="noopener">
                    <i class="bi bi-box-arrow-up-right me-1"></i>{{ sl.name }}
                  </a>
                {% endfor %}
              </div>
            </section>
          {% endif %}
        </div>
      </div>
      <!-- Right Column: Map -->
      <div class="col-lg-6 p-0">
        <div class="h-100 w-100 d-flex align-items-center justify-content-center">
          {% if address and map_center.lat and map_center.lng and GOOGLE_MAPS_API_KEY %}
            <div id="menu-map" class="rounded w-100" style="height: 320px;"></div>
          {% else %}
            <div class="p-5 h-100 d-flex justify-content-center align-items-center text-center text-muted">
              <div>
                <i class="bi bi-geo-alt" style="font-size: 2.5rem;"></i>
                <div class="mt-2">No address has been set for this restaurant.</div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Menu Items Section -->
  <div class="menu-guest-card">
    {% for menu in menus %}
      <div class="menu-guest-section-title">{{ menu.name }}</div>
      {% for item in menu.items.all %}
        <div class="menu-guest-item">
          {% if item.image %}
            <img src="{% cloudinary_url item.image.public_id width=60 height=60 crop='fill' gravity='auto' %}" class="menu-guest-item-img" alt="{{ item.name }}">
          {% else %}
            <img src="{% static 'default_profile_pic.png' %}" class="menu-guest-item-img" alt="No image" style="object-fit:cover;">
          {% endif %}
          <div class="menu-guest-item-info">
            <div class="menu-guest-item-name">{{ item.name }}</div>
            {% if item.description %}
              <div class="menu-guest-item-desc">{{ item.description }}</div>
            {% endif %}
          </div>
          <div class="menu-guest-item-price">${{ item.price|floatformat:2 }}</div>
        </div>
      {% empty %}
        <div class="text-muted text-center mb-3">This menu currently has no items.</div>
      {% endfor %}
    {% empty %}
      <div class="text-muted text-center mb-3">No active menus found for this restaurant.</div>
    {% endfor %}
  </div>
  <!-- Menu Items Section -->
  <div class="menu-guest-card">
    {% for menu in menus %}
      <div class="menu-guest-section-title">{{ menu.name }}</div>
      {% for item in menu.items.all %}
        <div class="menu-guest-item">
          {% if item.image %}
            <img src="{% cloudinary_url item.image.public_id width=60 height=60 crop='fill' gravity='auto' %}" class="menu-guest-item-img" alt="{{ item.name }}">
          {% endif %}
          <div class="menu-guest-item-info">
            <div class="menu-guest-item-name">{{ item.name }}</div>
            {% if item.description %}
              <div class="menu-guest-item-desc">{{ item.description }}</div>
            {% endif %}
          </div>
          <div class="menu-guest-item-price">${{ item.price|floatformat:2 }}</div>
        </div>
      {% empty %}
        <div class="text-muted text-center mb-3">This menu currently has no items.</div>
      {% endfor %}
    {% empty %}
      <div class="text-muted text-center mb-3">No active menus found for this restaurant.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if address and map_center.lat and map_center.lng and GOOGLE_MAPS_API_KEY %}
<script>
  function initMenuMap() {
    var lat = parseFloat("{{ map_center.lat }}");
    var lng = parseFloat("{{ map_center.lng }}");
    var mapDiv = document.getElementById("menu-map");
    if (!mapDiv) return;
    var map = new google.maps.Map(mapDiv, {
      zoom: 15,
      center: {lat: lat, lng: lng},
      mapTypeControl: false,
      streetViewControl: false
    });
    // Use AdvancedMarkerElement if available, fallback to Marker
    if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
      new google.maps.marker.AdvancedMarkerElement({
        map: map,
        position: {lat: lat, lng: lng},
        title: "{{ profile.name|escapejs }}"
      });
    } else {
      new google.maps.Marker({
        position: {lat: lat, lng: lng},
        map: map,
        title: "{{ profile.name|escapejs }}"
      });
    }
  }
  // Google Maps API will call this when loaded
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMenuMap"></script>
{% endif %}
{% endblock %}