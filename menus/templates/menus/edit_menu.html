{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Edit Menu: {{ menu.name }}</h2>
            <!-- Form Errors Display -->
            {% if formset.non_form_errors %}
                <div class="alert alert-danger" role="alert">
                    {{ formset.non_form_errors }}
                </div>
            {% endif %}
            <form method="post" id="menu-form" novalidate>
                {% csrf_token %}
                {{ formset.management_form }}

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle" id="menu-items-table">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Name <span class="text-danger">*</span></th>
                                <th scope="col">Description</th>
                                <th scope="col">Price (€) <span class="text-danger">*</span></th>
                                <th scope="col">Category</th>
                                <th scope="col">Image</th>
                                <th scope="col">Available</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="formset-tbody">
                            {% for form in formset %}
                            <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
                                <!-- Hidden fields -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <td>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.description.errors.0 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.price }}
                                    {% if form.price.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.price.errors.0 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.category }}
                                    {% if form.category.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.category.errors.0 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td> <!-- ✅ 2. Add cell for the image upload field -->
                                    {{ form.image }}
                                    {% if form.image.errors %}<div class="invalid-feedback d-block">{{ form.image.errors.0 }}</div>{% endif %}
                                </td>
                                    <td class="text-center">
                                    {{ form.is_available }}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        {{ form.DELETE }}
                                        <button type="button" class="btn btn-outline-danger btn-sm delete-row" 
                                                title="Mark for deletion" 
                                                aria-label="Delete item {{ form.name.value|default:'new item' }}">
                                            <i class="fas fa-trash" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button type="button" id="add-row" class="btn btn-outline-primary">
                        <i class="fas fa-plus" aria-hidden="true"></i> Add New Item
                    </button>
                    
                    <div class="btn-group">
                        <a href="{% url 'menus:menu_detail' menu.pk %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success" id="save-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="fas fa-save" aria-hidden="true"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<template id="empty-form-template">
    {{ formset.empty_form.as_p|escapejs }}
</template>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // =================================================================
    // 1. Initialization
    // =================================================================
    const form = document.getElementById('menu-form');
    const addRowBtn = document.getElementById('add-row');
    const tbody = document.getElementById('formset-tbody');
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    const saveBtn = document.getElementById('save-btn');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;

    // =================================================================
    // 2. Row Management (My Improved Version)
    // =================================================================
    function addNewRow() {
        let formCount = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
        
        const newRow = document.createElement('tr');
        newRow.className = 'formset-row';
        newRow.dataset.formIndex = formCount;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        
        let cellsHtml = '';
        tempDiv.querySelectorAll('p').forEach(p => {
            cellsHtml += `<td>${p.innerHTML}</td>`;
        });
        
        cellsHtml += `
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm remove-row-new" title="Remove item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        newRow.innerHTML = cellsHtml;
        tbody.appendChild(newRow);
        
        totalFormsInput.value = formCount + 1;
        
        const firstInput = newRow.querySelector('input[type="text"]');
        if (firstInput) firstInput.focus();
    }

    // =================================================================
    // 3. Form Submission & Validation (Your Original Code - KEEP THIS)
    // =================================================================
    function validateForm() {
        let isValid = true;
        // Check all visible required inputs within the form
        const requiredFields = form.querySelectorAll('tbody tr:not([style*="display: none"]) input[required]');
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    }

    function showLoadingState() {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    }
    
    function hideLoadingState() {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save" aria-hidden="true"></i> Save Changes';
    }

    // =================================================================
    // 4. Event Listeners
    // =================================================================
    
    // Add new row
    addRowBtn.addEventListener('click', addNewRow);

    // Handle row deletion/removal
    tbody.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.delete-row');
        const removeBtn = e.target.closest('.remove-row-new');

        if (deleteBtn) { // For existing forms, mark for deletion
            const row = deleteBtn.closest('.formset-row');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = !deleteCheckbox.checked;
                row.style.textDecoration = deleteCheckbox.checked ? 'line-through' : 'none';
                row.style.opacity = deleteCheckbox.checked ? '0.6' : '1';
            }
        } else if (removeBtn) { // For new forms, just remove the row
            removeBtn.closest('.formset-row').remove();
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault(); // Stop submission if validation fails
            alert('Please fill out all required fields (marked with *).');
        } else {
            showLoadingState(); // Show loading state on successful validation
        }
    });
});
</script>
{% endblock %}
{% block extra_styles %}
<style>
.formset-row {
    transition: all 0.3s ease;
}

.formset-row:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.invalid-feedback {
    font-size: 0.875em;
}

.table-responsive {
    max-height: 60vh;
    overflow-y: auto;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9em;
    }
    
    .btn-sm {
        font-size: 0.8em;
    }
}
</style>
{% endblock %}