{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4 text-center">Edit Menu: {{ menu.name }}</h2>
    {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
            {{ formset.non_form_errors }}
        </div>
    {% endif %}
    <form method="post" id="menu-form" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}


        <!-- Hidden initial formset rows for JS to process -->
        <div id="initial-formset-rows" style="display:none;">
            {% for form in formset %}
            <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                {{ form.name }}
                {{ form.ingredients }}
                {{ form.price }}
                {{ form.section }}
                {{ form.image }}
                <div class="image-preview-wrapper">
                    <img src="" alt="Preview" class="img-thumbnail d-none" style="max-width: 80px; max-height: 80px;" />
                </div>
                {{ form.is_available }}
                {{ form.DELETE }}
            </div>
            {% endfor %}
        </div>
        <div id="sections-container">
            <!-- Sections will be rendered here by JS -->
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <button type="button" id="add-section" class="btn btn-outline-primary">
                <i class="fas fa-layer-group"></i> Add Section
            </button>
            <div class="btn-group">
                <a href="{% url 'menus:menu_detail' menu.pk %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-success" id="save-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <i class="fas fa-save" aria-hidden="true"></i> Save Changes
                </button>
            </div>
        </div>
    </form>
</div>
<template id="empty-form-template">
    {{ formset.empty_form.as_p|escapejs }}
</template>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modern Section & Card UI
    const form = document.getElementById('menu-form');
    const sectionsContainer = document.getElementById('sections-container');
    const addSectionBtn = document.getElementById('add-section');
    const saveBtn = document.getElementById('save-btn');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

    // Parse initial forms into sections
    function getInitialSections() {
        const forms = Array.from(document.querySelectorAll('.formset-row'));
        const sections = {};
        forms.forEach(row => {
            const sectionName = row.querySelector('select[name$="-section"]')?.value || 'Uncategorized';
            if (!sections[sectionName]) sections[sectionName] = [];
            sections[sectionName].push(row);
        });
        return sections;
    }

    // Render sections and cards
    function renderSections(sections) {
        sectionsContainer.innerHTML = '';
        Object.entries(sections).forEach(([section, items], idx) => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'menu-section mb-4 card';
            sectionDiv.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${section}</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary rename-section" data-section="${section}"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-section" data-section="${section}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3 sortable-items" data-section="${section}"></div>
                </div>
            `;
            const itemsRow = sectionDiv.querySelector('.sortable-items');
            items.forEach(row => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `<div class="card menu-item-card p-2 mb-2">${row.innerHTML}</div>`;
                itemsRow.appendChild(card);
            });
            sectionsContainer.appendChild(sectionDiv);
            // Enable drag-and-drop
            Sortable.create(itemsRow, {
                animation: 150,
                handle: '.card',
                draggable: '.col-md-6',
            });
        });
    }

    // Initial render
    let sections = getInitialSections();
    renderSections(sections);

    // Add section
    addSectionBtn.addEventListener('click', function() {
        const sectionName = prompt('Enter new section name:');
        if (sectionName && !sections[sectionName]) {
            sections[sectionName] = [];
            renderSections(sections);
        }
    });

    // Rename/delete section
    sectionsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.rename-section')) {
            const section = e.target.closest('.rename-section').dataset.section;
            const newName = prompt('Rename section:', section);
            if (newName && newName !== section && !sections[newName]) {
                sections[newName] = sections[section];
                delete sections[section];
                renderSections(sections);
            }
        } else if (e.target.closest('.delete-section')) {
            const section = e.target.closest('.delete-section').dataset.section;
            if (confirm(`Delete section "${section}" and all its items?`)) {
                delete sections[section];
                renderSections(sections);
            }
        }
    });

    // Image preview for each image input
    document.querySelectorAll('input[type="file"][name$="-image"]').forEach(function(input) {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const previewWrapper = e.target.closest('td, .card').querySelector('.image-preview-wrapper');
            const previewImg = previewWrapper.querySelector('img');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    previewImg.src = ev.target.result;
                    previewImg.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.src = '';
                previewImg.classList.add('d-none');
            }
        });
    });

    // Inline validation
    form.addEventListener('input', function(e) {
        if (e.target.matches('input, textarea, select')) {
            if (e.target.required && !e.target.value.trim()) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    });
});
</script>
{% endblock %}
{% block extra_styles %}
<style>
.menu-section.card {
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}
.menu-item-card {
    transition: box-shadow 0.2s;
    border: 1px solid #e3e3e3;
}
.menu-item-card:hover {
    box-shadow: 0 4px 16px rgba(0,123,255,0.12);
    border-color: #007bff;
}
.invalid-feedback {
    font-size: 0.875em;
}
.sortable-items {
    min-height: 40px;
}
.btn-outline-primary, .btn-outline-secondary, .btn-outline-danger {
    margin-right: 0.5em;
}
@media (max-width: 768px) {
    .menu-item-card {
        font-size: 0.95em;
    }
    .btn-sm {
        font-size: 0.8em;
    }
}
</style>
{% endblock %}